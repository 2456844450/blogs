# 复合类型

## 数组

数组（array）是一种数据格式，能够存储多个同类型的值。

声明数组的通用格式如下：

```cpp
typeName arrayName[arraySize]
```

只有在定义数组时才能使用初始化，此后就不能使用了，也不能将一个数组赋给另一个数组。如果只对数组的一部分进行初始化，则编译器将把其他元素设置为 0。

## 字符串

存储在连续字节中的一系列字符意味着可以将字符串存储在 char 数组中，其中每个字符都位于自己的数组元素中。

### 字符串输入

`cin` 使用空白（空格、制表符和换行符）来确定字符串的结束位置。

面向行的输入：`cin.getline()`、`cin.get()`。

### string 类

要使用 `string` 类，必须在程序中包含头文件 `string`。`string` 类位于名称空间 `std` 中，因此必须提供一条 `using` 编译指令。

函数 `strlen()` 是一个常规函数，它接受一个 C- 风格字符串作为参数，并返回该字符串包含的字符数。

## 结构简介

结构可以存储多种类型的数据。

![image](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/assets/cpp/15.png)

在 C++ 中，结构标记的用法与基本类型名相同。这种变化强调的是，结构声明定义了一种新类型。

## 共用体

![image](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/assets/cpp/16.png)

共用体常用于（但并非只能用于）节省内存。对于嵌入式系统编程，如控制烤箱、MP3 播放器或火星漫步者的处理器 - 这些应用程序来说，内存可能非常宝贵。

## 枚举

```cpp
enum spectrum { red, orange, yellow }
```

在默认情况下，后面没有被初始化的枚举量的值将比其前面的枚举量大 1。

## 指针和自由存储空间

计算机程序在存储数据时，必须跟踪的 3 种基本属性：信息存储在何处、存储的值为多少、存储的信息是什么类型。

只需要对变量应用地址运算符（&），就可以获得它的位置（如下图）。

![image](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/assets/cpp/17.png)

一种特殊类型的变量——指针用于存储值的地址。因此，指针名表示的是地址。`*` 运算符被称为间接值（indirect value）或解除引用（dereferencing）运算符，将其应用于指针，可以得到该地址处存储的地址（如下图）。

![image](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/assets/cpp/18.png)

#### 声明和初始化指针

声明如下：

```cpp
int * p_updates
```

这表明，`*p_updates` 的类型为 `int`。由于 * 运算符被用于指针，因此 `p_updates` 变量本身必须是指针。我们说 `p_updates` 指向 `int` 类型，我们还说 `p_updates` 的类型是指向 `int` 的指针，或 `int*`。可以这样说，`p_updates` 是指针（地址），而 `*p_updates` 是 `int`，而不是指针。

在 C++ 中，`int*` 是一种符合类型，是指向 `int` 的指针。

在 C++ 创建指针时，计算机将分配用来存储地址的内存，但不会分配用来存储指针所指向的数据的内存。

#### 使用 new 来分配内存

```cpp
int *pn = new int;
```

`new int` 告诉程序，需要适合存储 `int` 的内存。`new` 运算符根据类型来确定需要多少字节的内存。然后，它找到这样的内存，并返回其地址。接下来，将地址赋给 `pn`，`pn` 是被声明为指向 `int` 的指针。现在，`pn` 是地址，而 `*pn` 是存储在那里的值。

为一个数据对象（可以是结构，也可以是基本类型）获得并指定分配内存的通用格式如下：

```cpp
typeName *pointer_name = new typeName;
```

由于程序知道指针的类型，所以 `cout` 知道要读取多少字节以及如何解释它们。

`new` 分配的内存块通常与常规变量声明分配的内存块不同。常规变量被存储在被称为 `栈(stack)` 的内存区域中，而 `new` 从被称为 `堆（heap）` 或 `自由存储区(free store)` 的内存区域分配内存。

#### 使用 delete 释放内存

delete 运算符可以在使用完内存后，将其归还给内存池，这是通向最有效地使用内存的关键一步。

一定要配对地使用 `new` 和 `delete`，否则将发生内存泄露，也就是说，被分配的内存再也无法使用了。

只能用 `delete` 来释放使用 `new` 分配的内存。然而，对空指针使用 `delete` 是安全的。

使用 `new` 和 `delete` 时，应遵循以下原则：

![image](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/assets/cpp/19.png)

## 指针、数组和指针算术

指针和数组基本等价的原因在于指针算术和 C++ 内部处理数组的方式。将整数变量加 1 后，其值将增加 1；但将指针变量加 1 后，增加的量等于它指向的类型的字节数。

在多数情况下，C++ 将数组名解释为数组第 1 个元素的地址。

`stacks[1]` 和 `*(stacks + 1)` 是等价的。C++ 编译器将表达式 `stacks[1]` 看做是 `*(stacks + 1)`，这意味着先计算数组第 2 个元素的地址，然后找到存储在那里的值。最后的结果便是 `stacks[1]` 的含义。

```cpp
arrayname[i] become *(arrayname + i);

pointername[i] become *(pointername + i);
```

### 指针小结

声明指针：要声明指向指定类型的指针，需使用 `typeName * pointerName` 语法。

给指针赋值：应将内存地址赋给指针。可以对变量名使用 `&` 运算符，来获得被命名的内存的地址，`new` 运算符返回未命名的内存的地址。

对指针解除引用：对指针解除引用意味着获得指针指向的值。对指针引用解除引用或间接值运算符 `(*)` 来解除引用。

区分指针和指针所引向的值：如果 `pt` 是指向 `int` 的指针，则 `*pt` 不是指向 `int` 的指针，而是完全等同于同一个 `int` 类型的变量。`pt` 才是指针。

数组名：在多数情况下，C++ 将数组名视为数组的第一个元素的地址。

指针算术：C++ 允许将指针和整数相加。加 1 的结果等于原来的地址值加上指向的对象占用的总字节数。

使用数组声明来创建数组时，将采用静态联编，即数组的长度在编译时设置。使用 `new[]` 运算符创建数组时，将采用动态联编（动态数组），即将在运行时为数组分配空间，其长度也将在运行时设置。使用完这种数组后，应使用 `delete[]` 释放其占用的内存。

### 指针和字符串

在 `cout` 和多数 C++ 表达式中，`char` 数组名、`char` 指针以及用引号括起的字符串常量都被解释为字符串第一个字符的地址。

注意：应使用 `strcpy()` 或 `strncpy()`，而不是赋值运算符来将字符串赋给数组。

### 使用 new 创建动态结构

在运行时创建数组优于编译时创建数组，对于结构也是如此。

C++ 在访问结构成员时，如果结构标识符是结构名，则使用句点运算符；如果标识符是指向结构的指针，则使用箭头运算符。

### 自动存储、静态存储和动态存储

自动存储：在函数内部定义的常规变量使用自动存储空间，被称为自动变量，这意味着它们在所属的函数被调用时自动产生，在该函数结束时消亡。自动变量通常存储在栈中。这意味着执行代码块时，其中的变量将依次加入到栈中，而在离开代码块时，将按相反的顺序释放这些变量。

静态存储：静态存储是整个程序执行期间都存在的存储方式。将变量成为静态的方式有两种：一种是在函数外面定义它；另一种是在声明变量时使用关键字 `static`。

动态存储：`new` 和 `delete` 运算符提供了一种比自动变量和静态变量更灵活的方法。它们管理了一个内存池，这在 C++ 中被称为自由存储空间（free store）或堆（heap）。该内存池同用于静态变量和自动变量的内存是分开的。`new` 和 `delete` 可以让你在一个函数中分配内存，而在另一个函数中释放它。

如果使用 `new` 运算符在自由存储空间（或堆）上创建变量后，没有调用 `delete`，将会发生内存泄露，甚至会导致应用程序的内存被耗尽，出现内存耗尽错误，导致程序崩溃。

## 类型组合

## 数组的替代品

模板类 `vector` 和 `array` 是数组的替代品。

`array` 对象和数组存储在相同的内存区域（即栈）中，而 `vector` 对象存储在另一个区域（自由存储区或堆）中。

## 总结

数组、结构和指针是 C++ 的 3 种复合类型。数组可以在一个数据对象中存储多个同种类型的值。通过使用索引或下标，可以访问数组中各个元素。

结构可以将多个不同类型的值存储在同一数据对象中，可以使用成员关系运算符（.）来访问其中的成员。使用结构的第一步是创建结构模板，它定义结构存储了哪些成员。模板的名称将成为新类型的标识符，然后就可以声明这种类型的结构变量。

共用体可以存储一个值，但是这个值可以是不同的类型，成员名指出了使用的模式。

指针是被设计用来存储地址的变量。我们说，指针指向它存储的地址。指针声明指出了指针指向的对象的类型。对指针应用解除引用运算符（*），将得到指针指向的的位置中的值。

字符串是以空字符为结尾的一系列字符。字符串可用引号括起的字符串常量表示，其中隐式包含了结尾的空字符。可以将字符串存储在 `char` 数组中，可以用来被初始化为指向字符串的 `char` 指针表示字符串。函数 `strlen()` 返回字符串的长度，其中不包括空字符。函数 `strcpy()` 将字符串从一个位置复制到另一个位置。在使用这些函数时，应当包含头文件 `cstring` 和 `string.h`。

头文件 `string` 支持的 `C++ string` 类提供了另一种对用户更友好的字符串处理方法。具体地说，`string` 对象将根据要存储的字符串自动调整其大小，用户可以使用赋值运算符来复制字符串。