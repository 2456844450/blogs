# 抓包原理

抓包方式有两种：一种是代理模式，一种是网卡混杂模式。

- 代理模式：代理相当于一个中间人。客户端发送的所有请求需要先经过代理，然后再由代理发送给服务器；服务器对请求的响应由代理拦截，再由代理返回给客户端。（部分抓包工具开启的时候会自动将自己进程监听的端口设置为代理，这样一来就可以监听本机到服务器的请求并完成抓包处理了）。对于客户端而言，代理扮演服务器的角色。对于服务器而言，代理扮演客户端的角色。

- 网卡混杂模式：对于黑客来说，一般使用网卡混杂模式。默认情况下，网卡会过滤掉目标地址不是自己 MAC 的数据包。当黑客将自己的电脑网卡设置为混杂模式时，则会收到经过网卡的所有数据包，从而污染 ARP，同时告诉别人本机就是你要访问的网址，这样就能抓到包。


## https 抓包原理

https 协议的通信原理简单来说就是客户端和服务器先经过一个握手阶段协商好通信密钥，然后使用这个密钥对真正数据进行加解密传输实现安全通信。

握手阶段包括 4 次握手：

1. Client -> MiddleMan -> Server
  1. ClientHello 客户端发送会话 ID、随机数 Random_C、支持的所有压缩方式、支持的所有密码套件等；中间人获取到这些信息；中间人将这些信息发给服务器；
2. Server -> MiddleMan -> Client
  1. ServerHello 服务器发送会话 ID、随机数 Random_S、选择的压缩方式、选择的密码套件等；中间人获取到这些信息；中间人将这些信息发送给客户端；
  2. Certificate 服务器发送数字证书（服务器公钥+认证机构数字签名）；中间人获取到服务器证书的公钥；中间人将自己伪造的数字证书（伪造的公钥+伪造的数字签名）发给客户端，由于客户端已经安装了代理的根证书并且将其设置为可信任，因此会通过根证书的公钥验证伪造的数字签名，确认伪造的公钥的合法性，从而能够认证通过。伪造的数字签名由伪造的根证书私钥加密得到。
  3. ServerKeyExchange 服务器发送公钥相关信息；中间人获取到这些信息；中间人将这些信息发送给客户端；
  4. CertificateRequest 服务器发送证书请求消息（包含自己能理解的证书类型清单、能理解的认证机构名称清单；）中间人获取到这些信息；中间人将这些信息发送给客户端；
  5. ServerHelloDone 服务器发送问候结束消息；中间人获取到这些信息；中间人将这些信息发送给客户端；
3. Client -> MiddleMan -> Server
  1. Certificate 客户端发送数字证书（客户端公钥+认证机构数字签名）；中间人获取到客户端证书的公钥；中间人将自己伪造的数字证书（伪造的证书和伪造的数字签名）发给服务器；
  2. ClientKeyExchange 客户端发送中间人公钥加密的预备主密码；中间人获取到这些信息；中间人用私钥解密得到预备主密码，然后伪造一个预备主密码并用服务器公钥加密后发给服务器。
  3. CertificateVerify 客户端发送认证确认消息（证明含有客户端证书的私钥） 中间人获取到这些信息； 中间人利用客户端证书的公钥解密从而验证客户端数字签名，然后中间人发送伪造的认证确认消息，服务器利用中间人伪造的证书公钥解密从而验证中间人数字签名。
  4. ChangeCipherSpec 客户端发送切换密码消息；中间人获取到这些信息；中间人将这些信息发给服务器。
  5. Finished 客户端发送Finished消息（用通信密钥加密固定内容）；中间人获取到这些信息；中间人将这些信息发给服务器。
4. Server -> MiddleMan -> Client
  1. ChangeCipherSpec 服务器发送切换密码消息； 中间人获取到这些信息； 中间人将这些信息发给客户端。
  2. Finished 服务器发送Finished消息； 中间人获取到这些信息； 中间人将这些信息发给客户端。

中间人身份认证：

在服务器Certificate过程，中间人向客户端发送伪造的公钥和伪造的数字签名，客户端利用根证书的公钥解密数字签名，证明伪造的公钥的合法性，从而完成中间人的身份认证。

在客户端Certificate过程，中间人向服务器发送伪造的数字证书，服务器得到伪造的数字证明的公钥；在客户端CertificateVerify过程，中间人向服务器发送经过伪造的数字证书私钥签名的认证确认消息，服务器利用伪造的公钥解密，从而完成中间人的身份认证。

可见，https抓包相当于客户端－中间人，中间人－服务器 两部分https通信过程，这两部分的密码是不同的。关于身份认证，根证书是信任链的起点。