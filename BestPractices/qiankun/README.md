# 微前端实战 - 基于 qiankun 的最佳实践

## 引言

本文是针对微前端框架 `qiankun` 的实战教程，此前已有 [qiankun 源码解读](https://segmentfault.com/a/1190000022275991)，该文章也得到了官方大大的一定认可。（见下图）

![micro-practice](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/blogs/qiankun_practice/1.png)

### 什么是微前端？

在本教程开始前，我们先来了解一下什么是 `微前端`。

`微前端` 是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将单页面前端应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。各个前端应用还可以独立开发、独立部署。同时，它们也可以在共享组件的同时进行并行开发——这些组件可以通过 `NPM` 或者 `Git Tag、Git Submodule` 来管理。

[`qiankun（乾坤）`](https://github.com/umijs/qiankun) 就是一款由蚂蚁金服推出的比较成熟的微前端框架，基于 [`single-spa`](https://github.com/single-spa/single-spa) 进行二次开发，用于将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。（见下图）

![qiankun](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/blogs/qiankun/40.png)

### 什么情况需要用到微前端吗？

第一，传统的云控制台应用，几乎都会面临业务快速发展之后，单体应用进化成巨石应用的问题。我们要如何维护一个巨无霸中台应用？

第二，你的团队可能会有多个业务应用，这些业务同时服务于一个大平台。当用户在这个大平台上使用这些业务的时候，每当切换系统时，页面都会刷新，体验很差；在开发层面，多个业务有很多重复逻辑/组件，维护成本很高。如何解决这个问题？

如果有遇到类似的问题，那么就可以考虑使用微前端架构。

### 微前端架构有哪些优点？

`应用自治`：子应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新。这样可以达到细粒度迭代更新，降低发布新版本的风险，提升发布新版本的效率。

`技术栈无关`：主框架不限制接入应用的技术栈，子应用具备完全自主权。这意味着子应用可以任意选择自己的技术栈，如 `vue、react、angular` 等等。

`单一职责`：每个前端应用可以只关注于自己所需要完成的功能。这样可以更好的从业务上完成解耦，职责划分更加清晰，可维护性得到加强，健壮性得到保障。

`独立运行时`：每个子应用之间状态隔离，运行时状态不共享。

### 微前端的架构方案有哪些？

常见的微前端的架构方案有哪些？我们来分析一下：

`MPA`：部署简单、各应用之间硬隔离，天生具备技术栈无关、独立开发、独立部署的特性。缺点则也很明显，应用之间切换会造成浏览器重刷，由于产品域名之间相互跳转，流程体验上会存在断点。

`SPA`：天生具备体验上的优势，应用直接无刷新切换，能极大的保证多产品之间流程操作串联时的流程性。缺点则在于各应用技术栈之间是强耦合的。

`SPA 架构 + MPA 思想`：具备 SPA 的体验优势，又具有 MPA 的弱耦合优点，在优化体验与开发流程之间达到了一个平衡。这也是 `qiankun` 想做的事情，目前微前端架构的最优解决方案。

#### 微前端的技术方案有哪些？

常见的微前端的技术方案有哪些？这里我们只聊主要的两种，`iframe` 和 `HTML Entry`

##### iframe

`iframe` 作为一个非常 “古老” 的，人人都觉得普通的技术，却一直很管用。它能有效地将另一个网页/单页面应用嵌入到当前页面中，两个页面间的 `CSS` 和 `JavaScript` 是相互隔离的——除去 `iframe` 父子通信部分的代码，它们之间的代码是完全不相互干扰的。`iframe` 便相当于是创建了一个全新的独立的宿主环境，类似于沙箱隔离，它意味着前端应用之间可以相互独立运行。

`iframe` 确实挺好用的，但是也存在一些缺点：
  - 子项目需要改造，需要提供一组不带导航的功能
  - `iframe` 嵌入的显示区大小不容易控制，存在一定局限性
  - URL 的记录完全无效，页面刷新不能够被记忆，刷新会返回首页
  - `iframe` 功能之间的跳转是无效的
  - `iframe` 的样式显示、兼容性等都具有局限性
  - `iframe` 方式的应用之间通信和调试比较麻烦，存在不可控性风险

`iframe` 的优点是简单易用，缺点是用户体验差，应用之间通信困难。我们在微前端架构方案中，首选方案并不是 `iframe`。但是在接入第三方应用时，`iframe` 依旧是首选方案。所以 `iframe` 在我们本次实战教程中，将作为我们的优雅降级方案，兼容到第三方应用。

##### HTML Entry

直接将子应用以 HTML 作为入口，主框架可以通过 fetch html 的方式获取子应用的静态资源，同时将 HTML document 作为子节点挂载到主应用的指定容器中。

通过 `qiankun` 框架的帮助，我们可以获得和 `iframe` 一样简单易用的体验，并且将 `iframe` 的缺点大部分都消灭，在主应用中加载子应用的速度加快，并且可以加入缓存方案，页面之间跳转无刷新，用户体验大大提升。在开发时，所有的应用具有一致的开发体验，应用之间通信采用黑箱复用，并不需要了解其他应用的内部实现细节。

这也是 `qiankun` 所采用的方案，具体实现可以参照 [qiankun 源码解读](https://segmentfault.com/a/1190000022275991)，这里就不做复述了。

### 微前端架构概述

我们再对我们以 `qiankun` 实现的微前端架构来画个图进行总结（见下图）

![架构图](http://shadows-mall.oss-cn-shenzhen.aliyuncs.com/images/blogs/micro-front/3.png)

